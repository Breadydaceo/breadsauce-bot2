import telebot
import json
import requests
import uuid
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# Load config
with open("bot_config.json") as config_file:
    config = json.load(config_file)

TOKEN = config["telegram_bot_token"]
ADMIN_IDS = config["admin_ids"]
CATEGORIES = config["categories"]
SELLY_API_KEY = config["selly_api_key"]
DATABASE_PATH = config["database"]["path"]

bot = telebot.TeleBot(TOKEN)

try:
    with open(DATABASE_PATH) as db_file:
        data = json.load(db_file)
except FileNotFoundError:
    data = {"products": {}, "users": {}}

def save_data():
    with open(DATABASE_PATH, "w") as db_file:
        json.dump(data, db_file, indent=2)

@bot.message_handler(commands=["start"])
def send_welcome(message):
    user_id = str(message.from_user.id)
    username = message.from_user.username or "User"
    data["users"].setdefault(user_id, {"username": username, "balance": 0})
    save_data()
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("ğŸ’³ Gift Cards", callback_data="cat_Gift Cards"),
        InlineKeyboardButton("ğŸªª Fullz", callback_data="cat_Fullz"),
        InlineKeyboardButton("ğŸ§  BIN Numbers", callback_data="cat_BIN Numbers"),
        InlineKeyboardButton("ğŸ’´ CCs", callback_data="cat_CCs"),
        InlineKeyboardButton("ğŸ”® Glass", callback_data="cat_Glass"),
        InlineKeyboardButton("ğŸ’° Recharge", callback_data="recharge"),
        InlineKeyboardButton("ğŸ“‚ Listings", callback_data="listings"),
        InlineKeyboardButton("ğŸ‘¤ Profile", callback_data="profile"),
        InlineKeyboardButton("ğŸ“œ Rules", callback_data="rules")
    )
    bot.send_message(message.chat.id, f"ğŸ‘‹ Welcome to *Bread Sauce*, @{username}", reply_markup=kb, parse_mode="Markdown")

@bot.callback_query_handler(func=lambda call: call.data.startswith("cat_"))
def show_products(call):
    category = call.data.split("_", 1)[1]
    for pid, prod in data["products"].items():
        if prod["category"].lower() == category.lower():
            kb = InlineKeyboardMarkup(row_width=3)
            kb.add(
                InlineKeyboardButton("âœ… Buy", callback_data=f"buy_{pid}"),
                InlineKeyboardButton("ğŸš« Cancel", callback_data="cancel"),
                InlineKeyboardButton("ğŸ”™ Back", callback_data="main_menu")
            )
            text = f"ğŸ›ï¸ {prod['name']}
ğŸ’° Price: {prod['price']} BTC"
            bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=kb, parse_mode="Markdown")
            return
    bot.answer_callback_query(call.id, "No products available.", show_alert=True)

@bot.callback_query_handler(func=lambda call: call.data == "main_menu")
def main_menu(call):
    send_welcome(call.message)

@bot.callback_query_handler(func=lambda call: call.data == "cancel")
def cancel_back(call):
    send_welcome(call.message)

bot.polling()
